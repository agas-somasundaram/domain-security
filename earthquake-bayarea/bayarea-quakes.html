<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Bay Area Earthquake Tracker (USGS + Leaflet)</title>

  <!-- Leaflet CSS/JS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    html,
    body {
      height: 100%;
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
    }

    #container {
      display: flex;
      height: 100%;
    }

    #map {
      flex: 1;
      height: 100%;
    }

    #sidebar {
      width: 350px;
      background: #f8f9fa;
      border-left: 1px solid #ddd;
      display: flex;
      flex-direction: column;
      box-shadow: -2px 0 5px rgba(0, 0, 0, 0.1);
      z-index: 1001;
      /* Above map controls if needed */
    }

    #sidebar-header {
      padding: 15px;
      background: #fff;
      border-bottom: 1px solid #ddd;
    }

    #sidebar-content {
      flex: 1;
      overflow-y: auto;
      padding: 10px;
    }

    .quake-item {
      background: white;
      border: 1px solid #eee;
      border-radius: 6px;
      padding: 10px;
      margin-bottom: 10px;
      cursor: pointer;
      transition: background 0.2s;
    }

    .quake-item:hover {
      background: #f0f0f0;
      border-color: #ccc;
    }

    .quake-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 5px;
    }

    .quake-mag {
      font-weight: bold;
      color: #d32f2f;
      font-size: 1.1em;
    }

    .quake-place {
      font-size: 0.95em;
      color: #333;
    }

    .quake-details {
      font-size: 0.85em;
      color: #666;
      display: flex;
      justify-content: space-between;
    }

    /* Controls overlay on map */
    .map-controls {
      position: absolute;
      top: 10px;
      left: 50px;
      /* moved right to avoid zoom controls */
      z-index: 1000;
      background: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
      display: flex;
      gap: 10px;
      align-items: flex-end;
    }

    .control-group {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .control-group label {
      font-size: 12px;
      font-weight: 600;
      color: #555;
    }

    .control-group input {
      padding: 6px 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 14px;
    }

    button.search-btn {
      padding: 6px 16px;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 600;
      height: 30px;
      /* Match input height approx */
    }

    button.search-btn:hover {
      background: #0056b3;
    }

    .legend {
      background: white;
      padding: 10px 12px;
      border-radius: 8px;
      box-shadow: 0 1px 6px rgba(0, 0, 0, 0.2);
      font: 14px/1.2 system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
    }

    .legend small {
      display: block;
      opacity: 0.7;
      margin-top: 6px;
    }
  </style>
</head>

<body>
  <div id="container">
    <div id="map">
      <div class="map-controls">
        <div class="control-group">
          <label for="locationInput">Location</label>
          <input type="text" id="locationInput" value="San Ramon, CA" placeholder="City, Address, or Zip">
        </div>
        <div class="control-group">
          <label for="radiusInput">Radius (miles)</label>
          <input type="number" id="radiusInput" value="10" min="1" max="500" style="width: 80px;">
        </div>
        <div class="control-group">
          <label for="periodInput">Time Period</label>
          <select id="periodInput" onchange="loadQuakes()"
            style="padding: 6px 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px;">
            <option value="1">Past Hour</option>
            <option value="4">Past 4 Hours</option>
            <option value="8" selected>Past 8 Hours</option>
            <option value="12">Past 12 Hours</option>
            <option value="24">Past 24 Hours</option>
            <option value="168">Past 7 Days</option>
            <option value="720">Past 30 Days</option>
          </select>
        </div>
        <div class="control-group">
          <label for="magInput">Magnitude</label>
          <select id="magInput" onchange="loadQuakes()"
            style="padding: 6px 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px;">
            <option value="all" selected>All</option>
            <option value="1.0">M1.0+</option>
            <option value="2.5">M2.5+</option>
            <option value="4.5">M4.5+</option>
            <option value="significant">Significant</option>
          </select>
        </div>
        <button class="search-btn" onclick="updateLocation()">Search</button>
      </div>
    </div>
    <div id="sidebar">
      <div id="sidebar-header">
        <h3 style="margin:0">Earthquakes</h3>
        <small id="result-count" style="color:#666">0 found</small>
      </div>
      <div id="sidebar-content">
        <!-- List items will go here -->
      </div>
    </div>
  </div>

  <script>
    // Initialize map
    const map = L.map("map").setView([37.7589, -121.9576], 10);

    // OpenStreetMap tiles
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    let centerMarker = null;
    let quakeLayer = L.layerGroup().addTo(map);
    let currentCenter = { lat: 37.7589, lon: -121.9576 }; // Default San Ramon
    let currentRadiusMiles = 10;

    // Custom blue pin icon
    const bluePinIcon = L.icon({
      iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png',
      shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
      iconSize: [25, 41],
      iconAnchor: [12, 41],
      popupAnchor: [1, -34],
      shadowSize: [41, 41]
    });

    // Custom red pin icon
    const redPinIcon = L.icon({
      iconUrl: 'red-pin.svg',
      iconSize: [60, 60], // Scaled size
      iconAnchor: [30, 60], // Tip is at bottom center
      popupAnchor: [0, -50]
    });

    async function updateLocation() {
      const location = document.getElementById('locationInput').value.trim();
      const radius = parseFloat(document.getElementById('radiusInput').value);

      if (!location) {
        alert("Please enter a location");
        return;
      }
      if (isNaN(radius) || radius <= 0) {
        alert("Please enter a valid radius");
        return;
      }

      currentRadiusMiles = radius;

      try {
        // Geocode location
        const response = await fetch(`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(location)}&countrycodes=us&format=json&limit=1`);
        const data = await response.json();

        if (data && data.length > 0) {
          const { lat, lon, display_name } = data[0];
          currentCenter = { lat: parseFloat(lat), lon: parseFloat(lon) };

          // Update center pin
          if (centerMarker) map.removeLayer(centerMarker);
          centerMarker = L.marker([currentCenter.lat, currentCenter.lon], { icon: bluePinIcon })
            .addTo(map)
            .bindPopup(`<b>Search center:</b><br>${display_name}`)
            .openPopup();

          // Fit map to radius and show circle
          const radiusMeters = currentRadiusMiles * 1609.34;

          // Remove existing circle if any (need to track it)
          if (window.currentCircle) map.removeLayer(window.currentCircle);

          window.currentCircle = L.circle([currentCenter.lat, currentCenter.lon], {
            color: '#3388ff',
            fillColor: '#3388ff',
            fillOpacity: 0.1,
            radius: radiusMeters
          }).addTo(map);

          map.fitBounds(window.currentCircle.getBounds());

          // Load quakes
          loadQuakes();
        } else {
          alert("Location not found");
        }
      } catch (err) {
        console.error(err);
        alert("Error searching location");
      }
    }

    function getDistanceFromLatLonInMiles(lat1, lon1, lat2, lon2) {
      var R = 3958.8; // Radius of the earth in miles
      var dLat = deg2rad(lat2 - lat1);  // deg2rad below
      var dLon = deg2rad(lon2 - lon1);
      var a =
        Math.sin(dLat / 2) * Math.sin(dLat / 2) +
        Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) *
        Math.sin(dLon / 2) * Math.sin(dLon / 2)
        ;
      var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      var d = R * c; // Distance in miles
      return d;
    }

    function deg2rad(deg) {
      return deg * (Math.PI / 180)
    }

    // Simple magnitude -> marker radius (pixels)
    function radiusFromMag(mag) {
      if (!mag) return 4;
      return Math.max(4, mag * 3);
    }

    async function loadQuakes() {
      const hours = parseInt(document.getElementById('periodInput').value);
      const mag = document.getElementById('magInput').value;

      // Determine feed based on hours
      let period = 'day';
      if (hours <= 1) period = 'hour';
      else if (hours <= 24) period = 'day';
      else if (hours <= 168) period = 'week';
      else period = 'month';

      const url = `https://earthquake.usgs.gov/earthquakes/feed/v1.0/summary/${mag}_${period}.geojson`;

      const res = await fetch(url);
      if (!res.ok) throw new Error(`USGS feed request failed: ${res.status}`);
      const geojson = await res.json();

      quakeLayer.clearLayers();
      const sidebarContent = document.getElementById('sidebar-content');
      sidebarContent.innerHTML = ''; // Clear list

      let count = 0;
      const visibleQuakes = [];

      for (const f of (geojson.features || [])) {
        const coords = f?.geometry?.coordinates;
        if (!coords || coords.length < 2) continue;

        const lon = coords[0];
        const lat = coords[1];
        const depthKm = coords[2];

        // Filter by time (client-side for granular options)
        const quakeTime = f?.properties?.time;
        const cutoffTime = Date.now() - (hours * 60 * 60 * 1000);
        if (quakeTime < cutoffTime) continue;

        // Filter by radius
        const distance = getDistanceFromLatLonInMiles(currentCenter.lat, currentCenter.lon, lat, lon);
        if (distance > currentRadiusMiles) continue;

        count++;
        const mag = f?.properties?.mag;
        const place = f?.properties?.place || "Unknown location";
        const time = f?.properties?.time ? new Date(f.properties.time) : null;
        const url = f?.properties?.url;

        // Add to map
        const marker = L.marker([lat, lon], {
          icon: redPinIcon
        });

        const popupHtml = `
          <div style="font: 14px/1.35 system-ui, -apple-system, Segoe UI, Roboto, sans-serif">
            <div><b>M ${mag ?? "?"}</b> â€” ${place}</div>
            <div>${time ? time.toLocaleString() : "Time unknown"}</div>
            <div>Depth: ${Number.isFinite(depthKm) ? depthKm.toFixed(1) + " km" : "?"}</div>
            <div>Dist: ${distance.toFixed(1)} miles</div>
            ${url ? `<div style="margin-top:6px"><a href="${url}" target="_blank" rel="noopener">USGS event page</a></div>` : ""}
          </div>
        `;
        marker.bindPopup(popupHtml);
        marker.addTo(quakeLayer);

        // Add to list
        visibleQuakes.push({
          mag, place, time, depthKm, distance, marker
        });
      }

      // Sort by time descending (newest first)
      visibleQuakes.sort((a, b) => b.time - a.time);

      // Render list
      visibleQuakes.forEach(q => {
        const item = document.createElement('div');
        item.className = 'quake-item';
        item.innerHTML = `
            <div class="quake-header">
                <span class="quake-mag">M ${q.mag ?? "?"}</span>
                <span style="font-size:0.8em; color:#888">${q.time ? q.time.toLocaleTimeString() : ""}</span>
            </div>
            <div class="quake-place">${q.place}</div>
            <div class="quake-details">
                <span>${q.depthKm ? q.depthKm.toFixed(1) + "km" : ""} depth</span>
                <span>${q.distance.toFixed(1)} mi away</span>
            </div>
          `;
        item.onclick = () => {
          q.marker.openPopup();
          map.panTo(q.marker.getLatLng());
        };
        sidebarContent.appendChild(item);
      });

      document.getElementById('result-count').textContent = `${count} found within ${currentRadiusMiles} miles`;
    }

    // Legend
    const legend = L.control({ position: "bottomright" }); // Moved to bottom right
    legend.onAdd = function () {
      const div = L.DomUtil.create("div", "legend");
      div.innerHTML = `
        <b>USGS Earthquakes</b><br/>
        <small>Refreshes every 60s</small>
      `;
      return div;
    };
    legend.addTo(map);

    // Initial load
    map.whenReady(async () => {
      // Set initial pin
      centerMarker = L.marker([currentCenter.lat, currentCenter.lon], { icon: bluePinIcon })
        .addTo(map)
        .bindPopup(`<b>Search center:</b><br>San Ramon, CA`)
        .openPopup();

      await loadQuakes();

      // Auto refresh
      setInterval(() => {
        loadQuakes().catch(err => console.error(err));
      }, 60_000);
    });

    // Add Enter key support
    document.getElementById('locationInput').addEventListener('keypress', function (e) {
      if (e.key === 'Enter') updateLocation();
    });

    document.getElementById('radiusInput').addEventListener('keypress', function (e) {
      if (e.key === 'Enter') updateLocation();
    });
  </script>
</body>

</html>