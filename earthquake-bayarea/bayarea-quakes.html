<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Bay Area Earthquake Tracker (USGS + Leaflet)</title>

  <!-- Leaflet CSS/JS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    html,
    body {
      height: 100%;
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    #container {
      display: flex;
      flex: 1;
      overflow: hidden;
    }

    #map {
      flex: 1;
      height: 100%;
    }

    #sidebar {
      width: 450px;
      background: #f8f9fa;
      border-left: 1px solid #ddd;
      display: flex;
      flex-direction: column;
      box-shadow: -2px 0 5px rgba(0, 0, 0, 0.1);
      z-index: 1001;
      /* Above map controls if needed */
    }

    #sidebar-header {
      padding: 15px;
      background: #fff;
      border-bottom: 1px solid #ddd;
    }

    #sidebar-content {
      flex: 1;
      overflow-y: auto;
      padding: 10px;
    }

    .quake-item {
      background: white;
      border: 1px solid #edf2f7;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05), 0 1px 2px rgba(0, 0, 0, 0.03);
      display: flex;
      flex-direction: column;
      gap: 12px;
      position: relative;
      overflow: hidden;
    }

    .quake-item::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 4px;
      background: transparent;
      transition: background 0.3s ease;
    }

    .quake-item:hover {
      background: #fff;
      border-color: #e2e8f0;
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.08), 0 4px 6px -2px rgba(0, 0, 0, 0.04);
      transform: translateY(-2px);
    }

    .quake-item:hover::before {
      background: #4299e1;
    }

    .quake-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 4px;
    }

    .quake-mag-group {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: 6px;
    }

    .quake-mag {
      font-weight: 900;
      color: #1a202c;
      font-size: 1.6em;
      display: flex;
      align-items: center;
      gap: 10px;
      line-height: 1;
    }

    .quake-time {
      font-size: 12px;
      color: #718096;
      font-weight: 600;
      text-align: right;
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 2px;
    }

    .quake-place {
      font-size: 18px;
      font-weight: 800;
      color: #2d3748;
      line-height: 1.3;
      margin-top: 4px;
    }

    .quake-details {
      font-size: 14px;
      color: #4a5568;
      display: flex;
      flex-direction: column;
      gap: 10px;
      border-top: 1px solid #edf2f7;
      padding-top: 14px;
    }

    .detail-row {
      display: flex;
      align-items: flex-start;
      gap: 8px;
    }

    .detail-icon {
      color: #718096;
      flex-shrink: 0;
      margin-top: 2px;
    }

    .detail-label {
      font-weight: 700;
      color: #718096;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 4px;
    }

    .detail-value {
      color: #2d3748;
      line-height: 1.5;
      font-size: 15px;
    }

    .depth-badge {
      padding: 3px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 800;
      text-transform: uppercase;
      letter-spacing: 0.025em;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
    }

    /* Controls section above map */
    .map-controls {
      background: white;
      padding: 10px 15px;
      border-bottom: 1px solid #ddd;
      display: flex;
      gap: 8px;
      flex-direction: column;
      flex-shrink: 0;
    }

    .control-row {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: flex-end;
    }

    .control-group {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }

    /* Responsive Layout */
    @media (max-width: 1024px) {
      #sidebar {
        width: 380px;
      }

      #locationInput {
        width: 250px !important;
      }
    }

    @media (max-width: 850px) {
      body {
        overflow: auto;
        height: auto;
      }

      #container {
        flex-direction: column;
        height: 1000px;
        /* Fixed height for mobile to allow scrolling */
        overflow: visible;
      }

      #map {
        height: 500px;
        flex: none;
      }

      #sidebar {
        width: 100%;
        height: auto;
        border-left: none;
        border-top: 1px solid #ddd;
        box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.05);
      }

      #sidebar-content {
        max-height: 600px;
      }

      .control-row {
        justify-content: center;
      }

      #locationInput {
        width: 100% !important;
        max-width: 400px;
      }
    }

    .legend {
      display: flex;
      gap: 12px;
      margin-top: 8px;
      font-size: 14px;
      align-items: center;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      display: inline-block;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
      vertical-align: middle;
      margin-right: 4px;
    }

    .control-group label {
      font-size: 14px;
      font-weight: 600;
      color: #555;
    }

    .control-group input {
      padding: 6px 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 16px;
    }

    button.search-btn {
      padding: 6px 20px;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 600;
      height: 36px;
      font-size: 16px;
      /* Match input height approx */
    }

    button.search-btn:hover {
      background: #0056b3;
    }

    .small-btn {
      padding: 2px 6px;
      font-size: 12px;
      cursor: pointer;
      border: 1px solid #ccc;
      border-radius: 4px;
      background: #f8f9fa;
      color: #333;
      font-weight: 500;
      transition: all 0.2s;
    }

    .small-btn:hover {
      background: #e9ecef;
      border-color: #adb5bd;
    }

    .legend-old {
      background: white;
      padding: 10px 12px;
      border-radius: 8px;
      box-shadow: 0 1px 6px rgba(0, 0, 0, 0.2);
      font: 14px/1.2 system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
    }

    .legend-old small {
      display: block;
      opacity: 0.7;
      margin-top: 6px;
    }

    .derived-tag {
      font-size: 10px;
      background: #ebf8ff;
      color: #3182ce;
      padding: 1px 4px;
      border-radius: 3px;
      margin-left: 4px;
      font-weight: 700;
      text-transform: uppercase;
      vertical-align: middle;
    }

    .confidence-high {
      color: #38a169;
    }

    .confidence-med {
      color: #d69e2e;
    }

    .confidence-low {
      color: #e53e3e;
    }
  </style>
</head>

<body>
  <div class="map-controls">
    <h2
      style="margin: 0; font-size: 1.2em; color: #333; display: flex; align-items: center; gap: 10px; white-space: nowrap;">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
        stroke-linecap="round" stroke-linejoin="round" style="color: #d32f2f;">
        <path
          d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z" />
      </svg>
      EarthQuake tracker
    </h2>
    <div class="control-row" style="align-items: flex-start; gap: 20px;">
      <div class="control-group">
        <label for="locationInput">Center Location</label>
        <input type="text" id="locationInput" placeholder="e.g. San Francisco" value="San Francisco"
          style="width: 350px;" />
      </div>
      <div class="control-group">
        <label for="radiusInput" id="radiusLabel">Radius (miles)</label>
        <input type="number" id="radiusInput" value="50" style="width: 60px;" />
      </div>
      <div class="control-group">
        <label for="periodInput">Time Period</label>
        <select id="periodInput" onchange="loadQuakes()"
          style="padding: 6px 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 16px; height: 36px;">
          <option value="1">Past Hour</option>
          <option value="4">Past 4 Hours</option>
          <option value="8" selected>Past 8 Hours</option>
          <option value="12">Past 12 Hours</option>
          <option value="24">Past 24 Hours</option>
          <option value="48">Past 2 Days</option>
          <option value="72">Past 3 Days</option>
          <option value="120">Past 5 Days</option>
          <option value="168">Past 7 Days</option>
          <option value="360">Past 15 Days</option>
          <option value="720">Past 30 Days</option>
        </select>
      </div>
      <div class="control-group">
        <label for="depthUnitInput">Distance Unit</label>
        <select id="depthUnitInput" onchange="updateDepthLegend(); loadQuakes();"
          style="padding: 6px 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 16px; height: 36px;">
          <option value="km">Kilometers</option>
          <option value="mi" selected>Miles</option>
        </select>
      </div>

      <div class="legend mag-legend"
        style="margin-top: 0; border-left: 1px solid #ddd; padding-left: 15px; flex-direction: column; align-items: flex-start; gap: 6px;">
        <div style="display: flex; align-items: center; gap: 8px;">
          <span style="font-weight: 600;">Magnitude</span>
          <button class="small-btn" onclick="setAllMagRanges(true)">All</button>
          <button class="small-btn" onclick="setAllMagRanges(false)">Clear</button>
        </div>
        <div style="display: flex; gap: 12px;">
          <label class="legend-item"><input type="checkbox" checked data-range="low"
              onchange="toggleMagRange('low', this.checked)"> <span class="dot"
              style="background: #ffff00"></span>&lt;2.5</label>
          <label class="legend-item"><input type="checkbox" checked data-range="mid"
              onchange="toggleMagRange('mid', this.checked)"> <span class="dot"
              style="background: #fd7e14"></span>2.5-4.5</label>
          <label class="legend-item"><input type="checkbox" checked data-range="high"
              onchange="toggleMagRange('high', this.checked)"> <span class="dot"
              style="background: #dc3545"></span>4.5-6.0</label>
          <label class="legend-item"><input type="checkbox" checked data-range="extreme"
              onchange="toggleMagRange('extreme', this.checked)"> <span class="dot"
              style="background: #6f42c1"></span>&ge;6.0</label>
        </div>
      </div>

      <div class="legend depth-legend" id="depthLegend"
        style="margin-top: 0; border-left: 1px solid #ddd; padding-left: 15px; flex-direction: column; align-items: flex-start; gap: 6px;">
        <div style="display: flex; align-items: center; gap: 8px;">
          <span style="font-weight: 600;">Depth</span>
          <button class="small-btn" onclick="setAllDepthRanges(true)">All</button>
          <button class="small-btn" onclick="setAllDepthRanges(false)">Clear</button>
        </div>
        <div style="display: flex; gap: 12px;">
          <label class="legend-item"><input type="checkbox" checked data-range="shallow"
              onchange="toggleDepthRange('shallow', this.checked)"> <span class="dot"
              style="background: #4caf50;"></span><span id="depth-range-1">0-6mi</span></label>
          <label class="legend-item"><input type="checkbox" checked data-range="intermediate"
              onchange="toggleDepthRange('intermediate', this.checked)"> <span class="dot"
              style="background: #ffeb3b;"></span><span id="depth-range-2">6-19mi</span></label>
          <label class="legend-item"><input type="checkbox" checked data-range="deep"
              onchange="toggleDepthRange('deep', this.checked)"> <span class="dot"
              style="background: #ff9800;"></span><span id="depth-range-3">19-43mi</span></label>
          <label class="legend-item"><input type="checkbox" checked data-range="verydeep"
              onchange="toggleDepthRange('verydeep', this.checked)"> <span class="dot"
              style="background: #f44336;"></span><span id="depth-range-4">&gt;43mi</span></label>
        </div>
      </div>

      <div class="control-group" style="align-self: center;">
        <button onclick="updateMap()" class="search-btn">Search</button>
      </div>
    </div>
  </div>

  <div id="container">
    <div id="map"></div>
    <div id="sidebar">
      <div id="sidebar-header" style="background: #f1f3f5;">
        <div id="result-count" style="font-weight: 700; color: #495057; font-size: 14px;">Total : 0 within Radius : 0mi
        </div>
      </div>
      <div id="sidebar-content">
        <!-- List items will go here -->
      </div>
    </div>
  </div>

  <script>
    // Initialize map
    const map = L.map("map").setView([37.7589, -121.9576], 10);

    // OpenStreetMap tiles
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    let centerMarker = null;
    let quakeLayer = L.layerGroup().addTo(map);
    let currentCenter = { lat: 37.7749, lon: -122.4194 }; // Default San Francisco
    let currentRadiusMiles = 50;
    const addressCache = new Map();

    // Custom blue pin icon
    const bluePinIcon = L.icon({
      iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png',
      shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
      iconSize: [25, 41],
      iconAnchor: [12, 41],
      popupAnchor: [1, -34],
      shadowSize: [41, 41]
    });

    async function updateMap() {
      const location = document.getElementById('locationInput').value.trim();
      const radius = parseFloat(document.getElementById('radiusInput').value);

      if (!location) {
        alert("Please enter a location");
        return;
      }
      if (isNaN(radius) || radius <= 0) {
        alert("Please enter a valid radius");
        return;
      }

      // Convert radius to miles if user entered km
      const unit = document.getElementById('depthUnitInput').value;
      currentRadiusMiles = unit === 'km' ? kmToMiles(radius) : radius;

      try {
        // Geocode location
        const response = await fetch(`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(location)}&countrycodes=us&format=json&limit=1`);
        const data = await response.json();

        if (data && data.length > 0) {
          const { lat, lon, display_name } = data[0];
          currentCenter = { lat: parseFloat(lat), lon: parseFloat(lon) };

          // Update center pin
          if (centerMarker) map.removeLayer(centerMarker);
          centerMarker = addMarker(currentCenter.lat, currentCenter.lon, `<b>Search center:</b><br>${display_name}`, true);
          centerMarker.addTo(map).openPopup();

          // Update input field to show the actual address found
          document.getElementById('locationInput').value = display_name;

          // Fit map to radius and show circle
          const radiusMeters = currentRadiusMiles * 1609.34;

          // Remove existing circle if any (need to track it)
          if (window.currentCircle) map.removeLayer(window.currentCircle);

          window.currentCircle = L.circle([currentCenter.lat, currentCenter.lon], {
            color: '#3388ff',
            fillColor: '#3388ff',
            fillOpacity: 0.1,
            radius: radiusMeters
          }).addTo(map);

          map.fitBounds(window.currentCircle.getBounds());

          // Load quakes
          loadQuakes();
        } else {
          alert("Location not found");
        }
      } catch (err) {
        console.error(err);
        alert("Error searching location");
      }
    }

    function getDistanceFromLatLonInMiles(lat1, lon1, lat2, lon2) {
      var R = 3958.8; // Radius of the earth in miles
      var dLat = deg2rad(lat2 - lat1);  // deg2rad below
      var dLon = deg2rad(lon2 - lon1);
      var a =
        Math.sin(dLat / 2) * Math.sin(dLat / 2) +
        Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) *
        Math.sin(dLon / 2) * Math.sin(dLon / 2)
        ;
      var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      var d = R * c; // Distance in miles
      return d;
    }

    function deg2rad(deg) {
      return deg * (Math.PI / 180)
    }

    // Simple magnitude -> marker radius (pixels)
    function radiusFromMag(mag) {
      if (!mag) return 4;
      return Math.max(4, mag * 3);
    }

    const activeMagRanges = {
      low: true,     // < 2.5
      mid: true,     // 2.5 - 4.5
      high: true,    // 4.5 - 6.0
      extreme: true  // >= 6.0
    };

    const activeDepthRanges = {
      shallow: true,      // 0-10km
      intermediate: true, // 10-30km
      deep: true,         // 30-70km
      verydeep: true      // >70km
    };

    function toggleMagRange(range, active) {
      activeMagRanges[range] = active;
      loadQuakes();
    }

    function setAllMagRanges(active) {
      Object.keys(activeMagRanges).forEach(range => {
        activeMagRanges[range] = active;
        const checkbox = document.querySelector(`.mag-legend input[data-range="${range}"]`);
        if (checkbox) checkbox.checked = active;
      });
      loadQuakes();
    }

    function toggleDepthRange(range, active) {
      activeDepthRanges[range] = active;
      loadQuakes();
    }

    function setAllDepthRanges(active) {
      Object.keys(activeDepthRanges).forEach(range => {
        activeDepthRanges[range] = active;
        const checkbox = document.querySelector(`.depth-legend input[data-range="${range}"]`);
        if (checkbox) checkbox.checked = active;
      });
      loadQuakes();
    }

    function getColorForMagnitude(mag) {
      if (mag < 2.5) return '#ffff00'; // Bright Yellow (Warning)
      if (mag < 4.5) return '#fd7e14'; // Orange
      if (mag < 6.0) return '#dc3545'; // Red (Danger)
      return '#6f42c1'; // Purple (Significant)
    }

    // Convert km to miles
    function kmToMiles(km) {
      return km * 0.621371;
    }

    // Format depth based on selected unit
    function formatDepth(depthKm) {
      const unit = document.getElementById('depthUnitInput').value;
      if (!Number.isFinite(depthKm)) return '?';

      if (unit === 'mi') {
        const depthMi = kmToMiles(depthKm);
        return depthMi.toFixed(1) + ' mi';
      }
      return depthKm.toFixed(1) + ' km';
    }

    // Update depth legend based on selected unit
    function updateDepthLegend() {
      const unit = document.getElementById('depthUnitInput').value;

      // Update radius label
      if (unit === 'mi') {
        document.getElementById('radiusLabel').textContent = 'Radius (miles)';
      } else {
        document.getElementById('radiusLabel').textContent = 'Radius (km)';
      }

      // Update depth legend
      if (unit === 'mi') {
        document.getElementById('depth-range-1').textContent = '0-6mi';
        document.getElementById('depth-range-2').textContent = '6-19mi';
        document.getElementById('depth-range-3').textContent = '19-43mi';
        document.getElementById('depth-range-4').textContent = '>43mi';
      } else {
        document.getElementById('depth-range-1').textContent = '0-10km';
        document.getElementById('depth-range-2').textContent = '10-30km';
        document.getElementById('depth-range-3').textContent = '30-70km';
        document.getElementById('depth-range-4').textContent = '>70km';
      }
    }

    // Format distance (for radius display in results)
    function formatDistance(distanceMiles) {
      const unit = document.getElementById('depthUnitInput').value;
      if (unit === 'km') {
        const distanceKm = distanceMiles / 0.621371;
        return distanceKm.toFixed(1) + ' km';
      }
      return distanceMiles.toFixed(1) + ' mi';
    }

    // Depth color mapping (shallow = green, deep = red)
    function getColorForDepth(depthKm) {
      if (!Number.isFinite(depthKm)) return '#999';
      // 0-10km green, 10-30km yellow, 30-70km orange, >70km red
      if (depthKm < 10) return '#4caf50'; // green
      if (depthKm < 30) return '#ffeb3b'; // yellow
      if (depthKm < 70) return '#ff9800'; // orange
      return '#f44336'; // red
    }

    function getPinSvg(lat, lon, color, idSuffix = '') {
      return `
          <svg width="24" height="34" viewBox="0 0 24 34" fill="none" xmlns="http://www.w3.org/2000/svg" style="filter: drop-shadow(0 1px 2px rgba(0,0,0,0.3)); vertical-align: middle; margin-right: 5px;">
             <defs>
              <radialGradient id="grad-${lat}-${lon}${idSuffix}" cx="50%" cy="50%" r="50%" fx="30%" fy="30%">
                <stop offset="0%" style="stop-color:white;stop-opacity:0.9" />
                <stop offset="60%" style="stop-color:${color};stop-opacity:1" />
                <stop offset="100%" style="stop-color:#dc3545;stop-opacity:1" />
              </radialGradient>
            </defs>
            <!-- Needle -->
            <path d="M12 12 L12 32" stroke="#dc3545" stroke-width="4" stroke-linecap="round" />
            <!-- Head -->
            <circle cx="12" cy="12" r="10" fill="url(#grad-${lat}-${lon}${idSuffix})" />
          </svg>
        `;
    }

    function addMarker(lat, lon, popupText, isCenter = false, color = '#ff0000', depthKm = null) {
      const el = document.createElement('div');
      el.className = 'marker';

      if (isCenter) {
        // Blue pin for center
        el.innerHTML = `
          <svg width="30" height="42" viewBox="0 0 30 42" fill="none" xmlns="http://www.w3.org/2000/svg" style="filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));">
            <path d="M15 0C6.71573 0 0 6.71573 0 15C0 26.25 15 42 15 42C15 42 30 26.25 30 15C30 6.71573 23.2843 0 15 0Z" fill="#007bff"/>
            <circle cx="15" cy="15" r="6" fill="white"/>
          </svg>
        `;
      } else {
        // Pin with depth indicator
        const depthColor = depthKm !== null ? getColorForDepth(depthKm) : '#000';
        const pinSvg = getPinSvg(lat, lon, color, depthKm !== null ? '-d' + Math.round(depthKm) : '');
        // Add a small circle in the center to show depth
        el.innerHTML = pinSvg.replace('</svg>', `<circle cx="12" cy="12" r="3" fill="${depthColor}" stroke="white" stroke-width="0.5"/></svg>`);
      }
      const customIcon = L.divIcon({
        className: 'custom-div-icon',
        html: el.innerHTML,
        iconAnchor: isCenter ? [15, 42] : [12, 32], // Adjust anchor based on icon size
        popupAnchor: isCenter ? [0, -40] : [0, -28]
      });

      const marker = L.marker([lat, lon], { icon: customIcon });
      if (popupText) {
        marker.bindPopup(popupText);
      }
      return marker;
    }

    function getRelativeTime(date) {
      if (!date) return "";
      const diffMs = Date.now() - date.getTime();
      const diffMins = Math.floor(diffMs / 60000);
      const diffHours = Math.floor(diffMins / 60);
      const diffDays = Math.floor(diffHours / 24);

      if (diffMins < 1) return "just now";
      if (diffMins < 60) return `${diffMins}m ago`;
      if (diffHours < 24) return `${diffHours}h ago`;
      return `${diffDays}d ago`;
    }

    /**
     * Derived: Depth Category
     * Shallow < 10km, Intermediate 10-70km, Deep > 70km
     */
    function getDepthCategory(depth) {
      if (depth < 10) return "Shallow";
      if (depth <= 70) return "Intermediate";
      return "Deep";
    }

    /**
     * Derived: Confidence Label
     * Based on status, nst (stations), gap (azimuthal gap), and rms (residual)
     */
    function calculateConfidence(status, nst, gap, rms) {
      let score = 0;
      if (status === 'reviewed') score += 1;
      if (nst && nst > 20) score += 1;
      if (gap && gap < 120) score += 1;
      if (rms && rms < 0.5) score += 1;

      if (score >= 3) return { label: "High", level: "high" };
      if (score >= 1) return { label: "Moderate", level: "med" };
      return { label: "Low", level: "low" };
    }

    // Reverse geocode lat/lon to address
    async function getReverseGeocode(lat, lon, elementId) {
      const cacheKey = `${lat.toFixed(4)},${lon.toFixed(4)}`;
      if (addressCache.has(cacheKey)) {
        const el = document.getElementById(elementId);
        if (el) el.textContent = addressCache.get(cacheKey);
        return;
      }

      try {
        const response = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json&zoom=18`);
        const data = await response.json();
        const address = data.display_name || "Address not found";
        addressCache.set(cacheKey, address);
        const el = document.getElementById(elementId);
        if (el) el.textContent = address;
      } catch (err) {
        console.error("Geocoding error:", err);
        const el = document.getElementById(elementId);
        if (el) el.textContent = "Error fetching address";
      }
    }

    async function loadQuakes() {
      const hours = parseInt(document.getElementById('periodInput').value);
      // Use "all" magnitude feed; magnitude filtering is now handled by legend checkboxes
      const mag = 'all';

      // Determine feed based on hours
      let period = 'day';
      if (hours <= 1) period = 'hour';
      else if (hours <= 24) period = 'day';
      else if (hours <= 168) period = 'week';
      else period = 'month';

      const url = `https://earthquake.usgs.gov/earthquakes/feed/v1.0/summary/${mag}_${period}.geojson`;

      const res = await fetch(url);
      if (!res.ok) throw new Error(`USGS feed request failed: ${res.status}`);
      const geojson = await res.json();

      quakeLayer.clearLayers();
      const sidebarContent = document.getElementById('sidebar-content');
      sidebarContent.innerHTML = ''; // Clear list

      let count = 0;
      const visibleQuakes = [];

      for (const f of (geojson.features || [])) {
        const coords = f?.geometry?.coordinates;
        if (!coords || coords.length < 2) continue;

        const lon = coords[0];
        const lat = coords[1];
        const depthKm = coords[2];

        // Filter by time (client-side for granular options)
        const quakeTime = f?.properties?.time;
        const cutoffTime = Date.now() - (hours * 60 * 60 * 1000);
        if (quakeTime < cutoffTime) continue;

        // Filter by radius
        const distance = getDistanceFromLatLonInMiles(currentCenter.lat, currentCenter.lon, lat, lon);
        if (distance > currentRadiusMiles) continue;

        // Apply legend filters
        const qMag = f?.properties?.mag;
        let magRange = 'low';
        if (qMag >= 6.0) magRange = 'extreme';
        else if (qMag >= 4.5) magRange = 'high';
        else if (qMag >= 2.5) magRange = 'mid';

        if (!activeMagRanges[magRange]) continue;

        let depthRange = 'shallow';
        if (depthKm >= 70) depthRange = 'verydeep';
        else if (depthKm >= 30) depthRange = 'deep';
        else if (depthKm >= 10) depthRange = 'intermediate';

        if (!activeDepthRanges[depthRange]) continue;

        count++;
        const place = f?.properties?.place || "Unknown location";
        const time = f?.properties?.time ? new Date(f.properties.time) : null;
        const url = f?.properties?.url;

        // Add to map
        const marker = addMarker(lat, lon, null, false, getColorForMagnitude(qMag), depthKm);

        const confidence = calculateConfidence(f.properties.status, f.properties.nst, f.properties.gap, f.properties.rms);
        const depthCategory = getDepthCategory(depthKm);

        const popupHtml = `
          <div style="font: 14px/1.35 system-ui, -apple-system, Segoe UI, Roboto, sans-serif; min-width: 200px;">
            <div style="font-size: 16px; margin-bottom: 8px;"><b>${qMag ?? "?"} ${f.properties.magType ?? ""}</b> â€” ${place}</div>
            <div style="display: grid; grid-template-columns: auto 1fr; gap: 4px 12px; margin-bottom: 8px;">
              <span style="color: #666;">Time:</span> <span>${time ? time.toLocaleString() : "Time unknown"}</span>
              <span style="color: #666;">Depth:</span> <span>${formatDepth(depthKm)} (${depthCategory}) <small class="derived-tag">DERIVED</small></span>
              <span style="color: #666;">Dist:</span> <span>${formatDistance(distance)} <small class="derived-tag">DERIVED</small></span>
              <span style="color: #666;">Felt:</span> <span>${f.properties.felt ?? 0} reports / ${f.properties.cdi ?? 'N/A'} intensity</span>
              <span style="color: #666;">Confidence:</span> <span class="confidence-${confidence.level}">${confidence.label} <small class="derived-tag">DERIVED</small></span>
            </div>
            <div style="font-size: 11px; color: #999; margin-bottom: 8px;">
              USGS ID: ${f.id} | Status: ${f.properties.status.toUpperCase()}
            </div>
            <div style="border-top: 1px solid #eee; padding-top: 8px; display: flex; justify-content: space-between;">
              <a href="https://www.openstreetmap.org/?mlat=${lat.toFixed(4)}&mlon=${lon.toFixed(4)}&zoom=12" target="_blank" rel="noopener">Map Link</a>
              ${url ? `<a href="${url}" target="_blank" rel="noopener" style="font-weight: 700; color: #007bff;">USGS Event Page</a>` : ""}
            </div>
          </div>
        `;
        marker.bindPopup(popupHtml);
        marker.addTo(quakeLayer);

        // Add to list
        visibleQuakes.push({
          // USGS SOURCED FIELDS
          mag: qMag,
          magType: f.properties.magType,
          place,
          time,
          updated: f.properties.updated,
          status: f.properties.status,
          type: f.properties.type,
          felt: f.properties.felt,
          cdi: f.properties.cdi,
          sig: f.properties.sig,
          nst: f.properties.nst,
          gap: f.properties.gap,
          rms: f.properties.rms,
          url: f.properties.url,
          lat,
          lon,
          depthKm,

          // DERIVED FIELDS
          distance,
          depthCategory: getDepthCategory(depthKm),
          confidence: calculateConfidence(f.properties.status, f.properties.nst, f.properties.gap, f.properties.rms),

          // UI Helpers
          marker,
          depthColor: getColorForDepth(depthKm)
        });
      }

      // Sort by time descending (newest first)
      visibleQuakes.sort((a, b) => b.time - a.time);

      // Render list
      visibleQuakes.forEach(q => {
        const item = document.createElement('div');
        item.className = 'quake-item';
        const cardId = `quake-card-${Math.random().toString(36).substr(2, 9)}`;
        item.id = cardId;
        const addressId = `address-${cardId}`;

        const magColor = getColorForMagnitude(q.mag);
        const depthColor = getColorForDepth(q.depthKm);
        const listPinSvg = getPinSvg(q.marker.getLatLng().lat, q.marker.getLatLng().lng, magColor, '-list-' + Math.random().toString(36).substr(2, 9))
          .replace('</svg>', `<circle cx="12" cy="12" r="3" fill="${depthColor}" stroke="white" stroke-width="0.5"/></svg>`);

        const timeStr = q.time ? q.time.toLocaleTimeString(undefined, { hour: 'numeric', minute: '2-digit', second: '2-digit', timeZoneName: 'short' }) : "";
        const relativeTime = getRelativeTime(q.time);

        item.innerHTML = `
            <div class="quake-header">
                <div class="quake-mag-group">
                  <span class="quake-mag">
                    ${listPinSvg} ${q.mag ?? "?"} <span style="font-size: 12px; color: #718096; margin-left: 4px; font-weight: 600;">${q.magType ?? ""}</span>
                  </span>
                  <div style="display: flex; gap: 8px; align-items: center;">
                    <span class="depth-badge" style="background:${q.depthColor}; color:#fff;">Depth: ${formatDepth(q.depthKm)}</span>
                    <span style="font-size: 11px; font-weight: 700; color: #718096; text-transform: uppercase;">${q.depthCategory} <small class="derived-tag">DERIVED</small></span>
                  </div>
                </div>
                <div class="quake-time">
                  <span>${timeStr}</span>
                  <span style="color: #4299e1; font-size: 11px;">${relativeTime.toUpperCase()}</span>
                </div>
            </div>
            <div class="quake-place">${q.place}</div>
            <div class="quake-details">
                <div class="detail-row">
                  <div class="detail-icon">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="22" y1="12" x2="18" y2="12"/><line x1="6" y1="12" x2="2" y2="12"/><line x1="12" y1="2" x2="12" y2="6"/><line x1="12" y1="22" x2="12" y2="18"/></svg>
                  </div>
                  <div>
                    <div class="detail-label">Epicenter</div>
                    <div id="${addressId}" class="detail-value" style="font-style: italic; color: #718096;">Fetching address...</div>
                    <div class="detail-value" style="font-size: 11px; color: #a0aec0; margin-top: 2px;">${q.lat.toFixed(4)}, ${q.lon.toFixed(4)}</div>
                  </div>
                </div>
                <div class="detail-row">
                  <div class="detail-icon">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>
                  </div>
                  <div>
                    <div class="detail-label">Distance <small class="derived-tag">DERIVED</small></div>
                    <div class="detail-value">${formatDistance(q.distance)} away from search center</div>
                  </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 4px;">
                  <div>
                    <div class="detail-label">Confidence <small class="derived-tag">DERIVED</small></div>
                    <div class="detail-value confidence-${q.confidence.level}" style="font-size: 13px;">${q.confidence.label}</div>
                  </div>
                  <div>
                    <div class="detail-label">Status</div>
                    <div class="detail-value" style="font-size: 13px;">${q.status.toUpperCase()}</div>
                  </div>
                </div>
            </div>
        `;
        item.onclick = () => {
          q.marker.openPopup();
          map.panTo(q.marker.getLatLng());
        };
        sidebarContent.appendChild(item);

        // Fetch address with a slight delay to avoid hitting rate limits too hard
        setTimeout(() => getReverseGeocode(q.lat, q.lon, addressId), 200 * visibleQuakes.indexOf(q));
      });

      document.getElementById('result-count').textContent = `Total : ${count} within Radius : ${formatDistance(currentRadiusMiles)}`;
    }

    const legend = L.control({ position: "bottomright" }); // Moved to bottom right
    legend.onAdd = function () {
      const div = L.DomUtil.create("div", "legend");
      div.innerHTML = `
        <b>USGS Earthquakes</b><br/>
        <small>Refreshes every 60s</small>
      `;
      return div;
    };
    legend.addTo(map);

    // Initial load
    map.whenReady(async () => {
      updateDepthLegend();
      // Trigger updateMap to geocode the default location and set up the map
      await updateMap();

      // Auto refresh
      setInterval(() => {
        loadQuakes().catch(err => console.error(err));
      }, 60_000);
    });

    // Add Enter key support
    document.getElementById('locationInput').addEventListener('keypress', function (e) {
      if (e.key === 'Enter') updateMap();
    });

    document.getElementById('radiusInput').addEventListener('keypress', function (e) {
      if (e.key === 'Enter') updateMap();
    });
  </script>
</body>

</html>